# –§–∞–∑–∞ 1, –î–µ–Ω—å 3. –ë–∞–∑–æ–≤—ã–π Telegram –±–æ—Ç —Å –¥–∏–∞–ª–æ–≥–∞–º–∏

## –¶–µ–ª—å (Definition of Done)
- –°–æ–∑–¥–∞–Ω –±–∞–∑–æ–≤—ã–π Telegram –±–æ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram 3.x
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (/start, /help, /settings)
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–∏–∞–ª–æ–≥–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram-dialog
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ middleware

## –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [aiogram 3.x Documentation](https://docs.aiogram.dev/en/latest/)
- [aiogram-dialog Documentation](https://github.com/Tishka17/aiogram_dialog)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Python asyncio Documentation](https://docs.python.org/3/library/asyncio.html)
- [structlog Documentation](https://www.structlog.org/en/stable/)

---

### 1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è

#### –û–ø–∏—Å–∞–Ω–∏–µ
–í —ç—Ç–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π Telegram –±–æ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram 3.x –∏ aiogram-dialog –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã, –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. **–ë–∞–∑–æ–≤—ã–π –±–æ—Ç** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–î–∏–∞–ª–æ–≥–∏** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞** - –ø—Ä–∏–µ–º –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
4. **Middleware** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

**–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–æ—Ç–∞:**
```python
# src/application/bot/main.py
import asyncio
import logging
import structlog
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.redis import RedisStorage
from aiogram_dialog import DialogRegistry

from src.config.settings import config
from src.application.bot.handlers import register_handlers
from src.application.bot.middlewares import register_middlewares
from src.application.bot.dialogs import register_dialogs


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
structlog.configure(
    processors=[
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.JSONRenderer(),
    ],
    logger_factory=structlog.stdlib.LoggerFactory(),
)

logger = structlog.get_logger()


async def main():
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    storage = RedisStorage.from_url(config.REDIS_URL)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
    bot = Bot(token=config.BOT_TOKEN)
    dp = Dispatcher(storage=storage)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
    dialog_registry = DialogRegistry(dp)
    register_dialogs(dialog_registry)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware
    register_middlewares(dp)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    register_handlers(dp)
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logger.info("Starting bot")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
```python
# src/application/bot/handlers/__init__.py
from aiogram import Dispatcher

from .commands import register_command_handlers
from .audio import register_audio_handlers
from .voice import register_voice_handlers
from .errors import register_error_handlers


def register_handlers(dp: Dispatcher):
    """Register all handlers."""
    register_command_handlers(dp)
    register_audio_handlers(dp)
    register_voice_handlers(dp)
    register_error_handlers(dp)
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥:**
```python
# src/application/bot/handlers/commands.py
from aiogram import Dispatcher, F
from aiogram.filters import Command
from aiogram.types import Message
from aiogram_dialog import DialogManager, StartMode

from src.application.bot.dialogs.settings import SettingsDialog
from src.application.bot.dialogs.help import HelpDialog


async def cmd_start(message: Message, dialog_manager: DialogManager):
    """Handle /start command."""
    await message.answer(
        f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}! üëã\n\n"
        "–Ø –±–æ—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∞—É–¥–∏–æ —Å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–µ–π —Å–ø–∏–∫–µ—Ä–æ–≤. "
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª, –∏ —è –ø—Ä–µ–æ–±—Ä–∞–∑—É—é –µ–≥–æ –≤ —Ç–µ–∫—Å—Ç.\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏."
    )


async def cmd_help(message: Message, dialog_manager: DialogManager):
    """Handle /help command."""
    await dialog_manager.start(HelpDialog.help, mode=StartMode.RESET_STACK)


async def cmd_settings(message: Message, dialog_manager: DialogManager):
    """Handle /settings command."""
    await dialog_manager.start(SettingsDialog.settings, mode=StartMode.RESET_STACK)


def register_command_handlers(dp: Dispatcher):
    """Register command handlers."""
    dp.message.register(cmd_start, Command("start"))
    dp.message.register(cmd_help, Command("help"))
    dp.message.register(cmd_settings, Command("settings"))
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞—É–¥–∏–æ:**
```python
# src/application/bot/handlers/audio.py
import structlog
from aiogram import Dispatcher, F
from aiogram.types import Message
from aiogram_dialog import DialogManager, StartMode

from src.application.bot.dialogs.transcription import TranscriptionDialog
from src.domains.audio.services import AudioService


logger = structlog.get_logger()


async def handle_audio(
    message: Message, 
    dialog_manager: DialogManager, 
    audio_service: AudioService
):
    """Handle audio files."""
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
    file_id = message.audio.file_id
    file_name = message.audio.file_name or f"audio_{file_id}.mp3"
    file_size = message.audio.file_size
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    if file_size > 200 * 1024 * 1024:  # 200 MB
        await message.answer(
            "‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 200 MB."
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await message.answer(
        f"üéµ –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ñ–∞–π–ª: {file_name}\n"
        f"üìä –†–∞–∑–º–µ—Ä: {file_size / 1024 / 1024:.2f} MB\n\n"
        "‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É..."
    )
    
    # –ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    await dialog_manager.start(
        TranscriptionDialog.transcription,
        data={"file_id": file_id, "file_name": file_name, "user_id": message.from_user.id},
        mode=StartMode.RESET_STACK
    )


async def handle_voice(
    message: Message, 
    dialog_manager: DialogManager, 
    audio_service: AudioService
):
    """Handle voice messages."""
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
    file_id = message.voice.file_id
    file_name = f"voice_{file_id}.ogg"
    file_size = message.voice.file_size
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    if file_size > 200 * 1024 * 1024:  # 200 MB
        await message.answer(
            "‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 200 MB."
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await message.answer(
        f"üé§ –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        f"üìä –†–∞–∑–º–µ—Ä: {file_size / 1024 / 1024:.2f} MB\n\n"
        "‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É..."
    )
    
    # –ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    await dialog_manager.start(
        TranscriptionDialog.transcription,
        data={"file_id": file_id, "file_name": file_name, "user_id": message.from_user.id},
        mode=StartMode.RESET_STACK
    )


def register_audio_handlers(dp: Dispatcher):
    """Register audio handlers."""
    dp.message.register(handle_audio, F.audio)
    dp.message.register(handle_voice, F.voice)
```

**Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
# src/application/bot/middlewares/logging.py
import structlog
from typing import Any, Awaitable, Callable, Dict
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject, User


logger = structlog.get_logger()


class LoggingMiddleware(BaseMiddleware):
    """Middleware for logging all updates."""
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user = data.get("event_from_user", None)
        if user and isinstance(user, User):
            user_info = {
                "user_id": user.id,
                "username": user.username,
                "first_name": user.first_name,
                "last_name": user.last_name,
            }
        else:
            user_info = {"user_id": "unknown"}
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        logger.info(
            "Received update",
            update_type=event.__class__.__name__,
            **user_info
        )
        
        # –í—ã–∑–æ–≤ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
        return await handler(event, data)
```

**–î–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```python
# src/application/bot/dialogs/settings.py
from aiogram.types import CallbackQuery, Message
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Select, Back
from aiogram_dialog.widgets.text import Const, Format
from aiogram_dialog.widgets.input import MessageInput

from src.domains.user.services import UserService


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
class SettingsDialog:
    settings = "settings"
    model = "settings_model"
    export = "settings_export"


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
async def get_settings_data(dialog_manager: DialogManager, user_service: UserService, **kwargs):
    """Get user settings data."""
    user_id = dialog_manager.event.from_user.id
    settings = await user_service.get_user_settings(user_id)
    
    return {
        "preferred_model": settings.preferred_model,
        "preferred_export_format": settings.preferred_export_format,
        "auto_detect_language": settings.auto_detect_language,
        "auto_delete_files": settings.auto_delete_files,
    }


async def on_model_selected(
    callback: CallbackQuery, 
    widget: Select, 
    dialog_manager: DialogManager, 
    item_id: str,
    user_service: UserService
):
    """Handle model selection."""
    user_id = callback.from_user.id
    await user_service.update_user_settings(user_id, preferred_model=item_id)
    await callback.answer(f"–ú–æ–¥–µ–ª—å {item_id} –≤—ã–±—Ä–∞–Ω–∞")
    await dialog_manager.update({"preferred_model": item_id})


async def on_export_selected(
    callback: CallbackQuery, 
    widget: Select, 
    dialog_manager: DialogManager, 
    item_id: str,
    user_service: UserService
):
    """Handle export format selection."""
    user_id = callback.from_user.id
    await user_service.update_user_settings(user_id, preferred_export_format=item_id)
    await callback.answer(f"–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ {item_id} –≤—ã–±—Ä–∞–Ω")
    await dialog_manager.update({"preferred_export_format": item_id})


async def toggle_auto_detect(
    callback: CallbackQuery, 
    button: Button, 
    dialog_manager: DialogManager,
    user_service: UserService
):
    """Toggle auto detect language setting."""
    user_id = callback.from_user.id
    current = dialog_manager.dialog_data.get("auto_detect_language", True)
    new_value = not current
    await user_service.update_user_settings(user_id, auto_detect_language=new_value)
    await dialog_manager.update({"auto_detect_language": new_value})


async def toggle_auto_delete(
    callback: CallbackQuery, 
    button: Button, 
    dialog_manager: DialogManager,
    user_service: UserService
):
    """Toggle auto delete files setting."""
    user_id = callback.from_user.id
    current = dialog_manager.dialog_data.get("auto_delete_files", True)
    new_value = not current
    await user_service.update_user_settings(user_id, auto_delete_files=new_value)
    await dialog_manager.update({"auto_delete_files": new_value})


# –û–∫–Ω–∞ –¥–∏–∞–ª–æ–≥–∞
settings_window = Window(
    Const("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
    Const("–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞."),
    Button(
        Format("üîÑ –ú–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: {preferred_model}"),
        id="model",
        on_click=lambda c, b, m: m.switch_to(SettingsDialog.model)
    ),
    Button(
        Format("üì§ –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞: {preferred_export_format}"),
        id="export",
        on_click=lambda c, b, m: m.switch_to(SettingsDialog.export)
    ),
    Button(
        Format("üîç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞: {'–í–∫–ª' if auto_detect_language else '–í—ã–∫–ª'}"),
        id="auto_detect",
        on_click=toggle_auto_detect
    ),
    Button(
        Format("üóë –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: {'–í–∫–ª' if auto_delete_files else '–í—ã–∫–ª'}"),
        id="auto_delete",
        on_click=toggle_auto_delete
    ),
    Button(
        Const("‚úÖ –ì–æ—Ç–æ–≤–æ"),
        id="done",
        on_click=lambda c, b, m: m.done()
    ),
    state=SettingsDialog.settings,
    getter=get_settings_data
)

model_window = Window(
    Const("üîÑ –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"),
    Const("–û—Ç –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –∑–∞–≤–∏—Å–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏."),
    Select(
        Format("‚úì {item}") if Format("{item}") == Format("{preferred_model}") else Format("{item}"),
        id="model_select",
        items=["whisper-large-v3", "whisper-turbo"],
        item_id_getter=lambda x: x,
        on_click=on_model_selected
    ),
    Back(Const("‚óÄÔ∏è –ù–∞–∑–∞–¥")),
    state=SettingsDialog.model,
    getter=get_settings_data
)

export_window = Window(
    Const("üì§ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"),
    Select(
        Format("‚úì {item}") if Format("{item}") == Format("{preferred_export_format}") else Format("{item}"),
        id="export_select",
        items=["docx", "srt", "json", "txt"],
        item_id_getter=lambda x: x,
        on_click=on_export_selected
    ),
    Back(Const("‚óÄÔ∏è –ù–∞–∑–∞–¥")),
    state=SettingsDialog.export,
    getter=get_settings_data
)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
settings_dialog = Dialog(settings_window, model_window, export_window)
```

**–î–∏–∞–ª–æ–≥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:**
```python
# src/application/bot/dialogs/transcription.py
from aiogram.types import CallbackQuery, Message
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Select, Row, Column, Group
from aiogram_dialog.widgets.text import Const, Format
from aiogram_dialog.widgets.input import MessageInput

from src.domains.audio.services import AudioService
from src.domains.transcription.services import TranscriptionService
from src.domains.diarization.services import DiarizationService
from src.domains.export.services import ExportService


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
class TranscriptionDialog:
    transcription = "transcription"
    processing = "transcription_processing"
    result = "transcription_result"
    export = "transcription_export"


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
async def start_transcription(dialog_manager: DialogManager, **kwargs):
    """Start transcription process."""
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    file_id = dialog_manager.start_data.get("file_id")
    file_name = dialog_manager.start_data.get("file_name")
    user_id = dialog_manager.start_data.get("user_id")
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞
    dialog_manager.dialog_data.update({
        "file_id": file_id,
        "file_name": file_name,
        "user_id": user_id,
        "status": "processing",
        "progress": 0,
    })
    
    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–∫–Ω—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await dialog_manager.switch_to(TranscriptionDialog.processing)


async def get_processing_data(dialog_manager: DialogManager, **kwargs):
    """Get processing data for the dialog."""
    return {
        "file_name": dialog_manager.dialog_data.get("file_name"),
        "status": dialog_manager.dialog_data.get("status"),
        "progress": dialog_manager.dialog_data.get("progress", 0),
    }


async def process_file(
    dialog_manager: DialogManager,
    audio_service: AudioService,
    transcription_service: TranscriptionService,
    diarization_service: DiarizationService,
    **kwargs
):
    """Process the file in background."""
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å
    # –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    for progress in range(0, 101, 10):
        dialog_manager.dialog_data["progress"] = progress
        await dialog_manager.update({"progress": progress})
        await asyncio.sleep(1)  # –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
    
    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    dialog_manager.dialog_data["status"] = "completed"
    await dialog_manager.switch_to(TranscriptionDialog.result)


async def get_result_data(dialog_manager: DialogManager, **kwargs):
    """Get result data for the dialog."""
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    return {
        "file_name": dialog_manager.dialog_data.get("file_name"),
        "transcription_id": "sample-id",  # –ó–∞–≥–ª—É—à–∫–∞
        "duration": 120,  # –ó–∞–≥–ª—É—à–∫–∞, —Å–µ–∫—É–Ω–¥—ã
        "language": "ru",  # –ó–∞–≥–ª—É—à–∫–∞
        "speakers": 2,  # –ó–∞–≥–ª—É—à–∫–∞
    }


async def on_export_click(
    callback: CallbackQuery, 
    button: Button, 
    dialog_manager: DialogManager,
    export_service: ExportService
):
    """Handle export button click."""
    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–∫–Ω—É —ç–∫—Å–ø–æ—Ä—Ç–∞
    await dialog_manager.switch_to(TranscriptionDialog.export)


# –û–∫–Ω–∞ –¥–∏–∞–ª–æ–≥–∞
processing_window = Window(
    Const("‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ"),
    Format("–§–∞–π–ª: {file_name}"),
    Format("–°—Ç–∞—Ç—É—Å: {status}"),
    Format("–ü—Ä–æ–≥—Ä–µ—Å—Å: {progress}%"),
    state=TranscriptionDialog.processing,
    getter=get_processing_data
)

result_window = Window(
    Const("‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"),
    Format("–§–∞–π–ª: {file_name}"),
    Format("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —Å–µ–∫."),
    Format("–Ø–∑—ã–∫: {language}"),
    Format("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–∫–µ—Ä–æ–≤: {speakers}"),
    Button(
        Const("üì§ –≠–∫—Å–ø–æ—Ä—Ç"),
        id="export",
        on_click=on_export_click
    ),
    Button(
        Const("üîÑ –ù–æ–≤–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è"),
        id="new",
        on_click=lambda c, b, m: m.done()
    ),
    state=TranscriptionDialog.result,
    getter=get_result_data
)

export_window = Window(
    Const("üì§ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞"),
    Button(
        Const("üìù DOCX"),
        id="docx",
        on_click=lambda c, b, m: None  # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
    ),
    Button(
        Const("üé¨ SRT"),
        id="srt",
        on_click=lambda c, b, m: None  # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
    ),
    Button(
        Const("üî¢ JSON"),
        id="json",
        on_click=lambda c, b, m: None  # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
    ),
    Button(
        Const("üìÑ TXT"),
        id="txt",
        on_click=lambda c, b, m: None  # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
    ),
    Button(
        Const("‚óÄÔ∏è –ù–∞–∑–∞–¥"),
        id="back",
        on_click=lambda c, b, m: m.switch_to(TranscriptionDialog.result)
    ),
    state=TranscriptionDialog.export
)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
transcription_dialog = Dialog(
    Window(
        Const("üéµ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∞—É–¥–∏–æ"),
        Const("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞..."),
        state=TranscriptionDialog.transcription,
        on_process_result=start_transcription
    ),
    processing_window,
    result_window,
    export_window
)
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤:**
```python
# src/application/bot/dialogs/__init__.py
from aiogram_dialog import DialogRegistry

from .settings import settings_dialog
from .help import help_dialog
from .transcription import transcription_dialog


def register_dialogs(registry: DialogRegistry):
    """Register all dialogs."""
    registry.register(settings_dialog)
    registry.register(help_dialog)
    registry.register(transcription_dialog)
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
```python
# src/application/bot/handlers/errors.py
import structlog
from aiogram import Dispatcher
from aiogram.types import ErrorEvent
from aiogram.exceptions import TelegramAPIError


logger = structlog.get_logger()


async def handle_errors(error: ErrorEvent, bot):
    """Handle errors in update processing."""
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ
    exception = error.exception
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
    logger.error(
        "Error while processing update",
        exception=str(exception),
        update=error.update.model_dump() if error.update else None,
    )
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
    if isinstance(exception, TelegramAPIError):
        # –û—à–∏–±–∫–∏ API Telegram
        logger.error("Telegram API error", code=exception.status_code)
    else:
        # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
        logger.exception("Unhandled exception")
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
    if error.update and hasattr(error.update, "message"):
        try:
            await bot.send_message(
                error.update.message.chat.id,
                "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
        except Exception as e:
            logger.error("Failed to send error message to user", exception=str(e))


def register_error_handlers(dp: Dispatcher):
    """Register error handlers."""
    dp.errors.register(handle_errors)
```

#### –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö/API

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä –∏ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
3. –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
4. –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞:**
```
/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
/help - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤:**
```
1. –î–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (SettingsDialog)
   - –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
   - –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞

2. –î–∏–∞–ª–æ–≥ —Å–ø—Ä–∞–≤–∫–∏ (HelpDialog)
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

3. –î–∏–∞–ª–æ–≥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (TranscriptionDialog)
   - –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
   - –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
   - –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

### 2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è

#### –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –±–æ—Ç–∞:**
   - –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –¥–ª—è –±–æ—Ç–∞
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º structlog
   - –°–æ–∑–¥–∞–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥:**
   - –°–æ–∑–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ /start, /help, /settings
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ
   - –î–æ–±–∞–≤—å—Ç–µ –±–∞–∑–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

3. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–µ–¥–∏–∞:**
   - –°–æ–∑–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –î–æ–±–∞–≤—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–æ–≤
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –±–∞–∑–æ–≤—É—é –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤

4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤:**
   - –°–æ–∑–¥–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –¥–∏–∞–ª–æ–≥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - –î–æ–±–∞–≤—å—Ç–µ –¥–∏–∞–ª–æ–≥ —Å–ø—Ä–∞–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ

5. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è middleware:**
   - –°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –î–æ–±–∞–≤—å—Ç–µ middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

6. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏ –¥–∏–∞–ª–æ–≥–æ–≤
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ (Common Pitfalls)

1. **–ü—Ä–æ–±–ª–µ–º—ã —Å aiogram 3.x:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ API –∏–∑ aiogram 2.x
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏

2. **–ü—Ä–æ–±–ª–µ–º—ã —Å –¥–∏–∞–ª–æ–≥–∞–º–∏:**
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏ –¥–∏–∞–ª–æ–≥–∞

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ñ–∞–π–ª–æ–≤:**
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å file_id –∏ file_path
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–æ–≤
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

#### –°–æ–≤–µ—Ç—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Performance Tips)

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å Telegram API:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
   - –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook –≤–º–µ—Å—Ç–æ long polling –≤ production

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤:**
   - –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
   - –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –æ–± –æ—à–∏–±–∫–∞—Ö
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### 3. –í–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è

#### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ /start, /help, /settings
- [ ] –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–µ–º –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –î–∏–∞–ª–æ–≥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç PEP 8 –∏ –≤–∫–ª—é—á–∞–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏—é
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è
- [ ] –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫ –∫–æ–¥—É –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞

#### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
# tests/application/bot/test_commands.py
import pytest
from unittest.mock import AsyncMock, patch

from aiogram.types import Message, User, Chat
from aiogram_dialog import DialogManager

from src.application.bot.handlers.commands import cmd_start, cmd_help, cmd_settings


@pytest.fixture
def message():
    """Create a mock message."""
    message = AsyncMock(spec=Message)
    message.from_user = User(id=123456789, is_bot=False, first_name="Test")
    message.chat = Chat(id=123456789, type="private")
    return message


@pytest.fixture
def dialog_manager():
    """Create a mock dialog manager."""
    return AsyncMock(spec=DialogManager)


async def test_cmd_start(message, dialog_manager):
    """Test the /start command handler."""
    await cmd_start(message, dialog_manager)
    message.answer.assert_called_once()
    assert "–ü—Ä–∏–≤–µ—Ç" in message.answer.call_args[0][0]


async def test_cmd_help(message, dialog_manager):
    """Test the /help command handler."""
    await cmd_help(message, dialog_manager)
    dialog_manager.start.assert_called_once()


async def test_cmd_settings(message, dialog_manager):
    """Test the /settings command handler."""
    await cmd_settings(message, dialog_manager)
    dialog_manager.start.assert_called_once()


# tests/application/bot/test_audio.py
import pytest
from unittest.mock import AsyncMock, patch

from aiogram.types import Message, User, Chat, Audio, Voice
from aiogram_dialog import DialogManager

from src.application.bot.handlers.audio import handle_audio, handle_voice


@pytest.fixture
def audio_message():
    """Create a mock audio message."""
    message = AsyncMock(spec=Message)
    message.from_user = User(id=123456789, is_bot=False, first_name="Test")
    message.chat = Chat(id=123456789, type="private")
    message.audio = Audio(
        file_id="test_file_id",
        file_unique_id="test_unique_id",
        duration=60,
        file_name="test.mp3",
        mime_type="audio/mp3",
        file_size=1024 * 1024  # 1 MB
    )
    return message


@pytest.fixture
def voice_message():
    """Create a mock voice message."""
    message = AsyncMock(spec=Message)
    message.from_user = User(id=123456789, is_bot=False, first_name="Test")
    message.chat = Chat(id=123456789, type="private")
    message.voice = Voice(
        file_id="test_file_id",
        file_unique_id="test_unique_id",
        duration=60,
        mime_type="audio/ogg",
        file_size=1024 * 1024  # 1 MB
    )
    return message


async def test_handle_audio(audio_message, dialog_manager):
    """Test the audio handler."""
    audio_service = AsyncMock()
    await handle_audio(audio_message, dialog_manager, audio_service)
    audio_message.answer.assert_called_once()
    dialog_manager.start.assert_called_once()


async def test_handle_voice(voice_message, dialog_manager):
    """Test the voice handler."""
    audio_service = AsyncMock()
    await handle_voice(voice_message, dialog_manager, audio_service)
    voice_message.answer.assert_called_once()
    dialog_manager.start.assert_called_once()
```

#### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /help –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ —Å–ø—Ä–∞–≤–∫–∏
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /settings –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤:**
   - –í –¥–∏–∞–ª–æ–≥–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –∏ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫—É
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ–≥–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
   - –í—ã–∑–æ–≤–∏—Ç–µ –æ—à–∏–±–∫—É –≤ –±–æ—Ç–µ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

## –í–æ–ø—Ä–æ—Å—ã –∫ –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫—É –∑–∞–¥–∞—á–∏
1. –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –±–æ—Ç–µ?
2. –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –∏–ª–∏ –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö?
3. –ö–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å?
4. –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É (–±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)?
5. –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–∏–∞–ª–æ–≥–∏?
# –§–∞–∑–∞ 3, –î–µ–Ω—å 11: –î–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∏—Å—Ç–æ—Ä–∏—è

## –¶–µ–ª—å (Definition of Done)
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram-dialog
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫–∞—á–µ—Å—Ç–≤–æ/—Å–∫–æ—Ä–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏, —è–∑—ã–∫ –∏ —Ç.–¥.)
- –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏

## –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [aiogram 3.x Documentation](https://docs.aiogram.dev/en/latest/)
- [aiogram-dialog Documentation](https://github.com/Tishka17/aiogram_dialog)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/en/20/)

---

## 1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è

### –û–ø–∏—Å–∞–Ω–∏–µ
–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º aiogram-dialog, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏—Ç —É–¥–æ–±–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∫–ª—é—á–∞—é—Ç:

1. **–î–∏–∞–ª–æ–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞
2. **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã**: –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
4. **–ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏**: –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–Ω–µ–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–¥–∞—á

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤

```python
# src/bot/dialogs/registry.py
from aiogram_dialog import DialogRegistry
from aiogram.dispatcher.router import Router

from src.bot.dialogs.main_menu import main_menu_dialog
from src.bot.dialogs.transcription import transcription_dialog
from src.bot.dialogs.settings import settings_dialog
from src.bot.dialogs.history import history_dialog
from src.bot.dialogs.progress import progress_dialog

def setup_dialogs(router: Router) -> DialogRegistry:
    """Register all dialogs in the registry."""
    registry = DialogRegistry(router)
    
    # Register dialogs
    registry.register(main_menu_dialog)
    registry.register(transcription_dialog)
    registry.register(settings_dialog)
    registry.register(history_dialog)
    registry.register(progress_dialog)
    
    return registry
```

#### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

```python
# src/bot/dialogs/main_menu.py
from typing import Any, Dict

from aiogram import F
from aiogram.types import CallbackQuery, Message
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Row, Select, Cancel
from aiogram_dialog.widgets.text import Const, Format

from src.bot.states import MainMenuState, TranscriptionState, SettingsState, HistoryState

async def start_handler(message: Message, dialog_manager: DialogManager):
    """Handler for /start command."""
    await dialog_manager.start(MainMenuState.main)

async def on_transcribe_selected(callback: CallbackQuery, button: Button, 
                                dialog_manager: DialogManager):
    """Handler for transcription button."""
    await dialog_manager.start(TranscriptionState.upload)

async def on_settings_selected(callback: CallbackQuery, button: Button, 
                              dialog_manager: DialogManager):
    """Handler for settings button."""
    await dialog_manager.start(SettingsState.main)

async def on_history_selected(callback: CallbackQuery, button: Button, 
                             dialog_manager: DialogManager):
    """Handler for history button."""
    await dialog_manager.start(HistoryState.list)

# Main menu window
main_menu_window = Window(
    Const("üéô –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Transcription Bot!\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"),
    Row(
        Button(
            Const("üîä –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ"),
            id="transcribe",
            on_click=on_transcribe_selected
        ),
    ),
    Row(
        Button(
            Const("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
            id="settings",
            on_click=on_settings_selected
        ),
        Button(
            Const("üìú –ò—Å—Ç–æ—Ä–∏—è"),
            id="history",
            on_click=on_history_selected
        ),
    ),
    state=MainMenuState.main
)

# Create dialog
main_menu_dialog = Dialog(main_menu_window)
```

#### –î–∏–∞–ª–æ–≥ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

```python
# src/bot/dialogs/transcription.py
from typing import Any, Dict

from aiogram import F
from aiogram.types import CallbackQuery, Message, ContentType
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Row, Select, Back, Cancel
from aiogram_dialog.widgets.text import Const, Format
from aiogram_dialog.widgets.input import MessageInput

from src.bot.states import TranscriptionState, ProgressState
from src.domains.audio.services import AudioService
from src.domains.transcription.services import TranscriptionService
from src.domains.user.services import UserService

async def on_file_received(message: Message, dialog_manager: DialogManager, 
                          audio_service: AudioService):
    """Handler for receiving audio file."""
    # Get user settings
    user_id = message.from_user.id
    user_service = UserService()
    settings = await user_service.get_user_settings(user_id)
    
    # Process file
    file_id = message.audio.file_id if message.audio else message.voice.file_id
    file_info = await audio_service.validate_audio_file(file_id)
    
    if file_info:
        # Store file info in dialog data
        dialog_manager.dialog_data["file_id"] = file_id
        dialog_manager.dialog_data["file_name"] = file_info.get("file_name", "audio")
        dialog_manager.dialog_data["file_size"] = file_info.get("file_size", 0)
        dialog_manager.dialog_data["duration"] = file_info.get("duration", 0)
        
        # Go to confirmation window
        await dialog_manager.next()
    else:
        # Show error message
        await message.answer("‚ùå –§–∞–π–ª –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. "
                           "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: mp3, wav, ogg, m4a. "
                           "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 200MB.")

async def on_start_transcription(callback: CallbackQuery, button: Button, 
                                dialog_manager: DialogManager,
                                transcription_service: TranscriptionService):
    """Handler for starting transcription."""
    # Get file info from dialog data
    file_id = dialog_manager.dialog_data["file_id"]
    user_id = callback.from_user.id
    
    # Get user settings
    user_service = UserService()
    settings = await user_service.get_user_settings(user_id)
    
    # Create transcription task
    task_id = await transcription_service.create_transcription_task(
        file_id=file_id,
        user_id=user_id,
        model=settings.get("model", "whisper-large-v3"),
        language=settings.get("language", "auto"),
        diarization=settings.get("diarization", True)
    )
    
    # Store task_id in dialog data
    dialog_manager.dialog_data["task_id"] = task_id
    
    # Switch to progress dialog
    await dialog_manager.start(ProgressState.tracking, data={"task_id": task_id})

# Upload window
upload_window = Window(
    Const("üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏."),
    Const("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: mp3, wav, ogg, m4a. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 200MB."),
    MessageInput(on_file_received, content_types=[ContentType.AUDIO, ContentType.VOICE]),
    Row(
        Cancel(Const("üîô –ù–∞–∑–∞–¥"))
    ),
    state=TranscriptionState.upload
)

# Confirmation window
confirmation_window = Window(
    Format("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:\n"
           "–ù–∞–∑–≤–∞–Ω–∏–µ: {file_name}\n"
           "–†–∞–∑–º–µ—Ä: {file_size:.2f} MB\n"
           "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration:.1f} —Å–µ–∫\n\n"
           "–ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é?"),
    Row(
        Button(
            Const("‚úÖ –ù–∞—á–∞—Ç—å"),
            id="start_transcription",
            on_click=on_start_transcription
        ),
        Back(Const("üîô –ù–∞–∑–∞–¥"))
    ),
    getter=lambda dialog_manager, **kwargs: {
        "file_name": dialog_manager.dialog_data.get("file_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
        "file_size": dialog_manager.dialog_data.get("file_size", 0) / (1024 * 1024),  # Convert to MB
        "duration": dialog_manager.dialog_data.get("duration", 0)
    },
    state=TranscriptionState.confirm
)

# Create dialog
transcription_dialog = Dialog(upload_window, confirmation_window)
```

#### –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä

```python
# src/bot/dialogs/progress.py
from typing import Any, Dict
import asyncio

from aiogram import F
from aiogram.types import CallbackQuery
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Row, Cancel
from aiogram_dialog.widgets.text import Const, Format

from src.bot.states import ProgressState, MainMenuState
from src.domains.transcription.services import TranscriptionService

async def progress_getter(dialog_manager: DialogManager, 
                         transcription_service: TranscriptionService, **kwargs):
    """Get progress information for the task."""
    task_id = dialog_manager.dialog_data.get("task_id")
    if not task_id:
        return {
            "progress": 0,
            "status": "–û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
            "progress_bar": "‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú",
            "is_completed": True,
            "is_failed": True
        }
    
    # Get task status
    task_status = await transcription_service.get_task_status(task_id)
    
    # Calculate progress bar
    progress = task_status.get("progress", 0)
    progress_blocks = int(progress * 10)
    progress_bar = "üü©" * progress_blocks + "‚¨ú" * (10 - progress_blocks)
    
    # Check if task is completed or failed
    is_completed = task_status.get("status") == "completed"
    is_failed = task_status.get("status") == "failed"
    
    # If completed or failed, stop polling
    if is_completed or is_failed:
        dialog_manager.dialog_data["stop_polling"] = True
        
        # If completed, store result in dialog data
        if is_completed:
            dialog_manager.dialog_data["result"] = task_status.get("result")
    
    return {
        "progress": int(progress * 100),
        "status": task_status.get("status_message", "–û–±—Ä–∞–±–æ—Ç–∫–∞..."),
        "progress_bar": progress_bar,
        "is_completed": is_completed,
        "is_failed": is_failed,
        "error_message": task_status.get("error_message", "")
    }

async def on_process_complete(callback: CallbackQuery, button: Button, 
                             dialog_manager: DialogManager):
    """Handler for viewing results."""
    # Get result from dialog data
    result = dialog_manager.dialog_data.get("result")
    
    # Here you would typically show the result or redirect to a result view
    # For now, we'll just go back to the main menu
    await dialog_manager.start(MainMenuState.main)

async def on_process_cancel(callback: CallbackQuery, button: Button, 
                           dialog_manager: DialogManager,
                           transcription_service: TranscriptionService):
    """Handler for canceling the task."""
    task_id = dialog_manager.dialog_data.get("task_id")
    if task_id:
        await transcription_service.cancel_task(task_id)
    
    # Go back to main menu
    await dialog_manager.start(MainMenuState.main)

async def on_dialog_started(start_data: Dict[str, Any], manager: DialogManager):
    """Called when dialog is started."""
    # Store task_id in dialog data
    if start_data and "task_id" in start_data:
        manager.dialog_data["task_id"] = start_data["task_id"]
    
    # Start polling for progress updates
    manager.dialog_data["stop_polling"] = False
    asyncio.create_task(poll_progress(manager))

async def poll_progress(manager: DialogManager):
    """Poll for progress updates."""
    while not manager.dialog_data.get("stop_polling", False):
        await manager.update({})  # Trigger getter to update progress
        await asyncio.sleep(1)  # Poll every second

# Progress tracking window
progress_window = Window(
    Const("üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ..."),
    Format("{progress_bar} {progress}%"),
    Format("–°—Ç–∞—Ç—É—Å: {status}"),
    Row(
        Button(
            Const("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"),
            id="cancel_process",
            on_click=on_process_cancel,
            when=lambda data, widget, manager: not data.get("is_completed") and not data.get("is_failed")
        ),
    ),
    Row(
        Button(
            Const("‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"),
            id="view_result",
            on_click=on_process_complete,
            when=lambda data, widget, manager: data.get("is_completed")
        ),
    ),
    Row(
        Button(
            Const("üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é"),
            id="back_to_menu",
            on_click=lambda c, b, m: m.start(MainMenuState.main),
            when=lambda data, widget, manager: data.get("is_failed")
        ),
    ),
    Format("‚ùå –û—à–∏–±–∫–∞: {error_message}", 
           when=lambda data, widget, manager: data.get("is_failed")),
    state=ProgressState.tracking,
    getter=progress_getter,
    on_start=on_dialog_started
)

# Create dialog
progress_dialog = Dialog(progress_window)
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# src/bot/dialogs/settings.py
from typing import Any, Dict

from aiogram import F
from aiogram.types import CallbackQuery
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Row, Select, Cancel, Group, Radio, Checkbox
from aiogram_dialog.widgets.text import Const, Format

from src.bot.states import SettingsState
from src.domains.user.services import UserService

async def settings_getter(dialog_manager: DialogManager, user_service: UserService, **kwargs):
    """Get user settings."""
    user_id = dialog_manager.event.from_user.id
    settings = await user_service.get_user_settings(user_id)
    
    return {
        "model": settings.get("model", "whisper-large-v3"),
        "language": settings.get("language", "auto"),
        "diarization": settings.get("diarization", True),
        "export_format": settings.get("export_format", "all")
    }

async def on_model_changed(callback: CallbackQuery, widget: Any, 
                          dialog_manager: DialogManager, item_id: str):
    """Handler for model selection."""
    user_id = callback.from_user.id
    user_service = UserService()
    await user_service.update_user_settings(user_id, {"model": item_id})
    await dialog_manager.update({})

async def on_language_changed(callback: CallbackQuery, widget: Any, 
                             dialog_manager: DialogManager, item_id: str):
    """Handler for language selection."""
    user_id = callback.from_user.id
    user_service = UserService()
    await user_service.update_user_settings(user_id, {"language": item_id})
    await dialog_manager.update({})

async def on_diarization_changed(callback: CallbackQuery, widget: Any, 
                               dialog_manager: DialogManager):
    """Handler for diarization toggle."""
    user_id = callback.from_user.id
    user_service = UserService()
    current_settings = await user_service.get_user_settings(user_id)
    current_diarization = current_settings.get("diarization", True)
    
    # Toggle diarization
    await user_service.update_user_settings(user_id, {"diarization": not current_diarization})
    await dialog_manager.update({})

async def on_export_format_changed(callback: CallbackQuery, widget: Any, 
                                 dialog_manager: DialogManager, item_id: str):
    """Handler for export format selection."""
    user_id = callback.from_user.id
    user_service = UserService()
    await user_service.update_user_settings(user_id, {"export_format": item_id})
    await dialog_manager.update({})

# Settings window
settings_window = Window(
    Const("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"),
    Const("\nü§ñ –ú–æ–¥–µ–ª—å:"),
    Radio(
        Format("‚úì {item[0]}") if F.data["model"] == F.item[1] else Format("{item[0]}"),
        id="model_select",
        item_id_getter=lambda item: item[1],
        items=[
            ("Whisper Large (–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)", "whisper-large-v3"),
            ("Whisper Turbo (–±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)", "whisper-turbo"),
        ],
        on_click=on_model_changed
    ),
    Const("\nüåê –Ø–∑—ã–∫:"),
    Radio(
        Format("‚úì {item[0]}") if F.data["language"] == F.item[1] else Format("{item[0]}"),
        id="language_select",
        item_id_getter=lambda item: item[1],
        items=[
            ("–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", "auto"),
            ("–†—É—Å—Å–∫–∏–π", "ru"),
            ("–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "en"),
            ("–†—É—Å—Å–∫–∏–π + –ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "ru+en"),
        ],
        on_click=on_language_changed
    ),
    Const("\nüë• –î–∏–∞—Ä–∏–∑–∞—Ü–∏—è (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–∏–∫–µ—Ä–∞–º):"),
    Checkbox(
        Const("‚úÖ –í–∫–ª—é—á–µ–Ω–∞"),
        Const("‚ùå –í—ã–∫–ª—é—á–µ–Ω–∞"),
        id="diarization_toggle",
        checked=F.data["diarization"],
        on_click=on_diarization_changed
    ),
    Const("\nüìÑ –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:"),
    Radio(
        Format("‚úì {item[0]}") if F.data["export_format"] == F.item[1] else Format("{item[0]}"),
        id="export_format_select",
        item_id_getter=lambda item: item[1],
        items=[
            ("–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã", "all"),
            ("–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç", "text"),
            ("DOCX", "docx"),
            ("SRT", "srt"),
            ("JSON", "json"),
        ],
        on_click=on_export_format_changed
    ),
    Row(
        Cancel(Const("üîô –ù–∞–∑–∞–¥"))
    ),
    state=SettingsState.main,
    getter=settings_getter
)

# Create dialog
settings_dialog = Dialog(settings_window)
```

#### –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
# src/bot/dialogs/history.py
from typing import Any, Dict
from datetime import datetime

from aiogram import F
from aiogram.types import CallbackQuery
from aiogram_dialog import Dialog, DialogManager, Window
from aiogram_dialog.widgets.kbd import Button, Row, Select, Cancel, SwitchTo, Start
from aiogram_dialog.widgets.text import Const, Format
from aiogram_dialog.widgets.media import DynamicMedia

from src.bot.states import HistoryState, MainMenuState
from src.domains.user.services import UserService
from src.domains.transcription.services import TranscriptionService

async def history_list_getter(dialog_manager: DialogManager, 
                             user_service: UserService, **kwargs):
    """Get user's transcription history."""
    user_id = dialog_manager.event.from_user.id
    page = dialog_manager.dialog_data.get("page", 1)
    items_per_page = 5
    
    # Get history items with pagination
    history_items = await user_service.get_user_history(
        user_id, 
        page=page, 
        items_per_page=items_per_page
    )
    
    # Get total count for pagination
    total_count = await user_service.get_user_history_count(user_id)
    total_pages = (total_count + items_per_page - 1) // items_per_page
    
    # Format items for display
    formatted_items = []
    for item in history_items:
        # Format date
        created_at = item.get("created_at", datetime.now())
        date_str = created_at.strftime("%d.%m.%Y %H:%M")
        
        # Format duration
        duration = item.get("duration", 0)
        duration_str = f"{int(duration // 60)}:{int(duration % 60):02d}"
        
        # Format status
        status = item.get("status", "unknown")
        status_emoji = "‚úÖ" if status == "completed" else "‚ùå" if status == "failed" else "üîÑ"
        
        # Add to list
        formatted_items.append({
            "id": item.get("id"),
            "file_name": item.get("file_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
            "date": date_str,
            "duration": duration_str,
            "status": f"{status_emoji} {status.capitalize()}"
        })
    
    return {
        "history_items": formatted_items,
        "page": page,
        "total_pages": max(1, total_pages),
        "has_prev": page > 1,
        "has_next": page < total_pages,
        "empty": len(formatted_items) == 0
    }

async def history_detail_getter(dialog_manager: DialogManager, 
                               transcription_service: TranscriptionService, **kwargs):
    """Get details for a specific history item."""
    item_id = dialog_manager.dialog_data.get("selected_item_id")
    if not item_id:
        return {"error": "Item not found"}
    
    # Get item details
    item = await transcription_service.get_task_details(item_id)
    if not item:
        return {"error": "Item not found"}
    
    # Format date
    created_at = item.get("created_at", datetime.now())
    date_str = created_at.strftime("%d.%m.%Y %H:%M")
    
    # Format duration
    duration = item.get("duration", 0)
    duration_str = f"{int(duration // 60)}:{int(duration % 60):02d}"
    
    # Format status
    status = item.get("status", "unknown")
    status_emoji = "‚úÖ" if status == "completed" else "‚ùå" if status == "failed" else "üîÑ"
    
    return {
        "id": item.get("id"),
        "file_name": item.get("file_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
        "date": date_str,
        "duration": duration_str,
        "status": f"{status_emoji} {status.capitalize()}",
        "model": item.get("model", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
        "language": item.get("language", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
        "diarization": "–í–∫–ª—é—á–µ–Ω–∞" if item.get("diarization", False) else "–í—ã–∫–ª—é—á–µ–Ω–∞",
        "speakers_count": item.get("speakers_count", 0),
        "error_message": item.get("error_message", ""),
        "is_completed": status == "completed",
        "is_failed": status == "failed"
    }

async def on_item_selected(callback: CallbackQuery, widget: Any, 
                          dialog_manager: DialogManager, item_id: str):
    """Handler for selecting a history item."""
    dialog_manager.dialog_data["selected_item_id"] = item_id
    await dialog_manager.switch_to(HistoryState.detail)

async def on_page_changed(callback: CallbackQuery, button: Button, 
                         dialog_manager: DialogManager, page_delta: int):
    """Handler for pagination."""
    current_page = dialog_manager.dialog_data.get("page", 1)
    new_page = max(1, current_page + page_delta)
    dialog_manager.dialog_data["page"] = new_page
    await dialog_manager.update({})

async def on_download_result(callback: CallbackQuery, button: Button, 
                            dialog_manager: DialogManager,
                            transcription_service: TranscriptionService):
    """Handler for downloading result."""
    item_id = dialog_manager.dialog_data.get("selected_item_id")
    if not item_id:
        return
    
    # Get download links
    download_links = await transcription_service.get_download_links(item_id)
    
    # Send links to user
    text = "üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n\n"
    if "text" in download_links:
        text += f"üìù [–¢–µ–∫—Å—Ç]({download_links['text']})\n"
    if "docx" in download_links:
        text += f"üìÑ [DOCX]({download_links['docx']})\n"
    if "srt" in download_links:
        text += f"üé¨ [SRT]({download_links['srt']})\n"
    if "json" in download_links:
        text += f"üîß [JSON]({download_links['json']})\n"
    
    await callback.message.answer(text, parse_mode="Markdown")

# History list window
history_list_window = Window(
    Const("üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π"),
    Format("–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}"),
    Format("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π.", when="empty"),
    Group(
        Select(
            Format("{item[file_name]} ({item[duration]}) - {item[status]}"),
            id="history_select",
            item_id_getter=lambda item: item["id"],
            items="history_items",
            on_click=on_item_selected
        ),
        width=1,
        when=lambda data, widget, manager: not data.get("empty")
    ),
    Row(
        Button(
            Const("‚¨ÖÔ∏è"),
            id="prev_page",
            on_click=lambda c, b, m: on_page_changed(c, b, m, -1),
            when="has_prev"
        ),
        Button(
            Const("‚û°Ô∏è"),
            id="next_page",
            on_click=lambda c, b, m: on_page_changed(c, b, m, 1),
            when="has_next"
        ),
    ),
    Row(
        Cancel(Const("üîô –ù–∞–∑–∞–¥"))
    ),
    state=HistoryState.list,
    getter=history_list_getter
)

# History detail window
history_detail_window = Window(
    Format("üìã –î–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n\n"
           "–§–∞–π–ª: {file_name}\n"
           "–î–∞—Ç–∞: {date}\n"
           "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration}\n"
           "–°—Ç–∞—Ç—É—Å: {status}\n"
           "–ú–æ–¥–µ–ª—å: {model}\n"
           "–Ø–∑—ã–∫: {language}\n"
           "–î–∏–∞—Ä–∏–∑–∞—Ü–∏—è: {diarization}\n"
           "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–∫–µ—Ä–æ–≤: {speakers_count}"),
    Format("‚ùå –û—à–∏–±–∫–∞: {error_message}", when="is_failed"),
    Row(
        Button(
            Const("üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"),
            id="download_results",
            on_click=on_download_result,
            when="is_completed"
        ),
    ),
    Row(
        Button(
            Const("üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é"),
            id="retry_transcription",
            on_click=lambda c, b, m: m.start(MainMenuState.main),  # Placeholder, would actually start a new transcription
            when="is_failed"
        ),
    ),
    Row(
        SwitchTo(
            Const("üîô –ö —Å–ø–∏—Å–∫—É"),
            id="back_to_list",
            state=HistoryState.list
        )
    ),
    state=HistoryState.detail,
    getter=history_detail_getter
)

# Create dialog
history_dialog = Dialog(history_list_window, history_detail_window)
```

#### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
# src/domains/user/models.py
from datetime import datetime
from typing import Optional, Dict, Any, List
from sqlalchemy import Column, Integer, String, Boolean, DateTime, ForeignKey, JSON, Float
from sqlalchemy.orm import relationship

from src.infrastructure.database.base import Base

class User(Base):
    """User model."""
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    telegram_id = Column(Integer, unique=True, nullable=False)
    username = Column(String, nullable=True)
    first_name = Column(String, nullable=True)
    last_name = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    settings = relationship("UserSettings", back_populates="user", uselist=False, cascade="all, delete-orphan")
    history = relationship("TranscriptionHistory", back_populates="user", cascade="all, delete-orphan")

class UserSettings(Base):
    """User settings model."""
    __tablename__ = "user_settings"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    model = Column(String, default="whisper-large-v3")
    language = Column(String, default="auto")
    diarization = Column(Boolean, default=True)
    export_format = Column(String, default="all")
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    user = relationship("User", back_populates="settings")

class TranscriptionHistory(Base):
    """Transcription history model."""
    __tablename__ = "transcription_history"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    task_id = Column(String, nullable=False)
    file_id = Column(String, nullable=False)
    file_name = Column(String, nullable=True)
    file_size = Column(Integer, nullable=True)
    duration = Column(Float, nullable=True)
    model = Column(String, nullable=True)
    language = Column(String, nullable=True)
    diarization = Column(Boolean, default=True)
    status = Column(String, default="pending")
    error_message = Column(String, nullable=True)
    result_path = Column(String, nullable=True)
    speakers_count = Column(Integer, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    user = relationship("User", back_populates="history")
```

#### –°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```python
# src/domains/user/services.py
from typing import Dict, Any, List, Optional
from datetime import datetime

from sqlalchemy import select, desc
from sqlalchemy.ext.asyncio import AsyncSession

from src.domains.user.models import User, UserSettings, TranscriptionHistory
from src.infrastructure.database.session import get_session

class UserService:
    """Service for user operations."""
    
    async def get_or_create_user(self, telegram_id: int, username: Optional[str] = None,
                               first_name: Optional[str] = None, last_name: Optional[str] = None) -> User:
        """Get or create a user by Telegram ID."""
        async with get_session() as session:
            # Check if user exists
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                # Create new user
                user = User(
                    telegram_id=telegram_id,
                    username=username,
                    first_name=first_name,
                    last_name=last_name
                )
                session.add(user)
                
                # Create default settings
                settings = UserSettings(user=user)
                session.add(settings)
                
                await session.commit()
                await session.refresh(user)
            
            return user
    
    async def get_user_settings(self, telegram_id: int) -> Dict[str, Any]:
        """Get user settings."""
        async with get_session() as session:
            # Get user
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                # Create user with default settings
                return await self.get_or_create_user(telegram_id)
            
            # Get settings
            result = await session.execute(
                select(UserSettings).where(UserSettings.user_id == user.id)
            )
            settings = result.scalars().first()
            
            if not settings:
                # Create default settings
                settings = UserSettings(user=user)
                session.add(settings)
                await session.commit()
                await session.refresh(settings)
            
            # Convert to dict
            return {
                "model": settings.model,
                "language": settings.language,
                "diarization": settings.diarization,
                "export_format": settings.export_format
            }
    
    async def update_user_settings(self, telegram_id: int, settings: Dict[str, Any]) -> None:
        """Update user settings."""
        async with get_session() as session:
            # Get user
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                # Create user with default settings
                user = await self.get_or_create_user(telegram_id)
            
            # Get settings
            result = await session.execute(
                select(UserSettings).where(UserSettings.user_id == user.id)
            )
            user_settings = result.scalars().first()
            
            if not user_settings:
                # Create default settings
                user_settings = UserSettings(user=user)
                session.add(user_settings)
            
            # Update settings
            for key, value in settings.items():
                if hasattr(user_settings, key):
                    setattr(user_settings, key, value)
            
            await session.commit()
    
    async def add_history_item(self, telegram_id: int, task_data: Dict[str, Any]) -> None:
        """Add item to user's transcription history."""
        async with get_session() as session:
            # Get user
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                # Create user with default settings
                user = await self.get_or_create_user(telegram_id)
            
            # Create history item
            history_item = TranscriptionHistory(
                user_id=user.id,
                task_id=task_data.get("task_id"),
                file_id=task_data.get("file_id"),
                file_name=task_data.get("file_name"),
                file_size=task_data.get("file_size"),
                duration=task_data.get("duration"),
                model=task_data.get("model"),
                language=task_data.get("language"),
                diarization=task_data.get("diarization", True),
                status=task_data.get("status", "pending")
            )
            session.add(history_item)
            await session.commit()
    
    async def update_history_item(self, task_id: str, update_data: Dict[str, Any]) -> None:
        """Update history item."""
        async with get_session() as session:
            # Get history item
            result = await session.execute(
                select(TranscriptionHistory).where(TranscriptionHistory.task_id == task_id)
            )
            history_item = result.scalars().first()
            
            if history_item:
                # Update fields
                for key, value in update_data.items():
                    if hasattr(history_item, key):
                        setattr(history_item, key, value)
                
                await session.commit()
    
    async def get_user_history(self, telegram_id: int, page: int = 1, 
                             items_per_page: int = 10) -> List[Dict[str, Any]]:
        """Get user's transcription history with pagination."""
        async with get_session() as session:
            # Get user
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                return []
            
            # Get history items with pagination
            offset = (page - 1) * items_per_page
            result = await session.execute(
                select(TranscriptionHistory)
                .where(TranscriptionHistory.user_id == user.id)
                .order_by(desc(TranscriptionHistory.created_at))
                .offset(offset)
                .limit(items_per_page)
            )
            history_items = result.scalars().all()
            
            # Convert to list of dicts
            return [
                {
                    "id": item.task_id,
                    "file_name": item.file_name,
                    "file_size": item.file_size,
                    "duration": item.duration,
                    "model": item.model,
                    "language": item.language,
                    "diarization": item.diarization,
                    "status": item.status,
                    "error_message": item.error_message,
                    "created_at": item.created_at,
                    "speakers_count": item.speakers_count
                }
                for item in history_items
            ]
    
    async def get_user_history_count(self, telegram_id: int) -> int:
        """Get count of user's history items."""
        async with get_session() as session:
            # Get user
            result = await session.execute(
                select(User).where(User.telegram_id == telegram_id)
            )
            user = result.scalars().first()
            
            if not user:
                return 0
            
            # Get count
            result = await session.execute(
                select(TranscriptionHistory)
                .where(TranscriptionHistory.user_id == user.id)
            )
            return len(result.scalars().all())
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤

```python
# src/bot/states.py
from aiogram.fsm.state import State, StatesGroup

class MainMenuState(StatesGroup):
    """Main menu states."""
    main = State()

class TranscriptionState(StatesGroup):
    """Transcription states."""
    upload = State()
    confirm = State()

class SettingsState(StatesGroup):
    """Settings states."""
    main = State()

class HistoryState(StatesGroup):
    """History states."""
    list = State()
    detail = State()

class ProgressState(StatesGroup):
    """Progress tracking states."""
    tracking = State()
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏

```python
# src/bot/setup.py
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.redis import RedisStorage
from aiogram.types import BotCommand

from src.bot.dialogs.registry import setup_dialogs
from src.bot.handlers.commands import register_command_handlers
from src.bot.handlers.callbacks import register_callback_handlers
from src.bot.handlers.messages import register_message_handlers
from src.config import settings

async def setup_bot():
    """Setup bot and dispatcher."""
    # Create storage
    storage = RedisStorage.from_url(settings.REDIS_URL)
    
    # Create bot and dispatcher
    bot = Bot(token=settings.BOT_TOKEN)
    dp = Dispatcher(storage=storage)
    
    # Register handlers
    register_command_handlers(dp)
    register_callback_handlers(dp)
    register_message_handlers(dp)
    
    # Setup dialogs
    dialog_registry = setup_dialogs(dp)
    
    # Set bot commands
    await bot.set_my_commands([
        BotCommand(command="start", description="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"),
        BotCommand(command="help", description="–ü–æ–º–æ—â—å"),
        BotCommand(command="settings", description="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"),
        BotCommand(command="history", description="–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π"),
    ])
    
    return bot, dp
```

### –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö/API

#### –°—Ö–µ–º—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
# src/domains/user/schemas.py
from typing import Optional, List, Dict, Any
from datetime import datetime
from pydantic import BaseModel, Field

class UserSettingsCreate(BaseModel):
    """Schema for creating user settings."""
    model: str = Field(default="whisper-large-v3")
    language: str = Field(default="auto")
    diarization: bool = Field(default=True)
    export_format: str = Field(default="all")

class UserSettingsUpdate(BaseModel):
    """Schema for updating user settings."""
    model: Optional[str] = None
    language: Optional[str] = None
    diarization: Optional[bool] = None
    export_format: Optional[str] = None

class UserSettings(BaseModel):
    """Schema for user settings."""
    model: str
    language: str
    diarization: bool
    export_format: str
    
    class Config:
        orm_mode = True

class TranscriptionHistoryItem(BaseModel):
    """Schema for transcription history item."""
    id: str
    file_name: Optional[str] = None
    file_size: Optional[int] = None
    duration: Optional[float] = None
    model: Optional[str] = None
    language: Optional[str] = None
    diarization: bool = True
    status: str
    error_message: Optional[str] = None
    created_at: datetime
    speakers_count: Optional[int] = None
    
    class Config:
        orm_mode = True

class TranscriptionHistoryList(BaseModel):
    """Schema for list of transcription history items."""
    items: List[TranscriptionHistoryItem]
    total: int
    page: int
    pages: int
```

## 2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è

### –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤**
   - –°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥—É–ª—å `src/bot/states.py` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤
   - –°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥—É–ª—å `src/bot/dialogs` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏–∞–ª–æ–≥–æ–≤ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é

2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏**
   - –°–æ–∑–¥–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
   - –î–æ–±–∞–≤—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

3. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞**
   - –°–æ–∑–¥–∞–π—Ç–µ –¥–∏–∞–ª–æ–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –î–æ–±–∞–≤—å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏

4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫**
   - –°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –¥–∏–∞–ª–æ–≥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

5. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏**
   - –°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
   - –î–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

6. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏**
   - –°–≤—è–∂–∏—Ç–µ –¥–∏–∞–ª–æ–≥–∏ —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

7. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
   - –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π
   - –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

8. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ (Common Pitfalls)

1. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - –ù–µ –±–ª–æ–∫–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ `asyncio.create_task()` –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

2. **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö**
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
   - –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π
   - –ò–∑–±–µ–≥–∞–π—Ç–µ –≥–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á
   - –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤

4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö**
   - –í—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –¥–∏–∞–ª–æ–≥–æ–≤
   - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

5. **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏**
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–π—Ç–µ —Å–º–µ—â–µ–Ω–∏–µ –∏ –ª–∏–º–∏—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
   - –ö–µ—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°–æ–≤–µ—Ç—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Performance Tips)

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π
   - –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ JOIN –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –ø–æ–ª–µ–π

2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –ö–µ—à–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Redis
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞
   - –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∫–µ—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

3. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**
   - –û–±–Ω–æ–≤–ª—è–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —á–∞—â–µ, —á–µ–º —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - –ì—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏**
   - –ê—Ä—Ö–∏–≤–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

5. **–£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞**
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - –î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º

## 3. –í–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è

### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏–∞–ª–æ–≥–∏ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∏—Å—Ç–æ—Ä–∏—è)
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –Ω–æ–≤—ã–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º
- [ ] –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –∏–º–µ—é—Ç –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á
- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º PEP 8 –∏ –∏–º–µ–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏—é

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
# tests/bot/test_dialogs.py
import pytest
from unittest.mock import AsyncMock, patch

from aiogram.types import Message, User as TelegramUser, Chat
from aiogram_dialog import DialogManager
from aiogram_dialog.test_tools import BotClient, MockMessageManager

from src.bot.dialogs.main_menu import main_menu_dialog
from src.bot.dialogs.settings import settings_dialog
from src.bot.dialogs.history import history_dialog
from src.bot.dialogs.progress import progress_dialog
from src.bot.states import MainMenuState, SettingsState, HistoryState, ProgressState

@pytest.fixture
def telegram_user():
    return TelegramUser(id=123456, is_bot=False, first_name="Test", username="test_user")

@pytest.fixture
def chat():
    return Chat(id=123456, type="private")

@pytest.fixture
def message(telegram_user, chat):
    return Message(message_id=1, date=1234567890, chat=chat, from_user=telegram_user)

@pytest.fixture
async def dialog_manager():
    manager = AsyncMock(spec=DialogManager)
    manager.dialog_data = {}
    manager.start = AsyncMock()
    manager.switch_to = AsyncMock()
    manager.update = AsyncMock()
    return manager

@pytest.mark.asyncio
async def test_main_menu_dialog(dialog_manager, message):
    """Test main menu dialog."""
    # Test start handler
    from src.bot.dialogs.main_menu import start_handler
    await start_handler(message, dialog_manager)
    dialog_manager.start.assert_called_once_with(MainMenuState.main)
    
    # Test navigation to transcription
    from src.bot.dialogs.main_menu import on_transcribe_selected
    await on_transcribe_selected(None, None, dialog_manager)
    dialog_manager.start.assert_called_with(TranscriptionState.upload)
    
    # Test navigation to settings
    from src.bot.dialogs.main_menu import on_settings_selected
    await on_settings_selected(None, None, dialog_manager)
    dialog_manager.start.assert_called_with(SettingsState.main)
    
    # Test navigation to history
    from src.bot.dialogs.main_menu import on_history_selected
    await on_history_selected(None, None, dialog_manager)
    dialog_manager.start.assert_called_with(HistoryState.list)

@pytest.mark.asyncio
async def test_settings_dialog(dialog_manager):
    """Test settings dialog."""
    # Mock user service
    user_service = AsyncMock()
    user_service.get_user_settings.return_value = {
        "model": "whisper-large-v3",
        "language": "auto",
        "diarization": True,
        "export_format": "all"
    }
    
    # Test settings getter
    from src.bot.dialogs.settings import settings_getter
    dialog_manager.event.from_user.id = 123456
    result = await settings_getter(dialog_manager, user_service=user_service)
    
    assert result["model"] == "whisper-large-v3"
    assert result["language"] == "auto"
    assert result["diarization"] is True
    assert result["export_format"] == "all"
    
    # Test model change
    from src.bot.dialogs.settings import on_model_changed
    callback = AsyncMock()
    callback.from_user.id = 123456
    await on_model_changed(callback, None, dialog_manager, "whisper-turbo")
    
    user_service.update_user_settings.assert_called_once_with(
        123456, {"model": "whisper-turbo"}
    )
    dialog_manager.update.assert_called_once()

@pytest.mark.asyncio
async def test_progress_dialog(dialog_manager):
    """Test progress dialog."""
    # Mock transcription service
    transcription_service = AsyncMock()
    transcription_service.get_task_status.return_value = {
        "progress": 0.5,
        "status": "processing",
        "status_message": "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...",
    }
    
    # Test progress getter
    from src.bot.dialogs.progress import progress_getter
    dialog_manager.dialog_data["task_id"] = "test-task-id"
    result = await progress_getter(dialog_manager, transcription_service=transcription_service)
    
    assert result["progress"] == 50
    assert result["status"] == "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ..."
    assert result["progress_bar"] == "üü©üü©üü©üü©üü©‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú"
    assert result["is_completed"] is False
    assert result["is_failed"] is False
    
    # Test completed task
    transcription_service.get_task_status.return_value = {
        "progress": 1.0,
        "status": "completed",
        "status_message": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
        "result": {"text": "Test transcription"}
    }
    
    result = await progress_getter(dialog_manager, transcription_service=transcription_service)
    
    assert result["progress"] == 100
    assert result["status"] == "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    assert result["progress_bar"] == "üü©üü©üü©üü©üü©üü©üü©üü©üü©üü©"
    assert result["is_completed"] is True
    assert dialog_manager.dialog_data["stop_polling"] is True
    assert dialog_manager.dialog_data["result"] == {"text": "Test transcription"}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–µ–Ω—é**
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∏—Å—Ç–æ—Ä–∏—è)
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–∞—Ö

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤**
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (mp3, wav, ogg, m4a)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–æ–≤ —Ä–∞–∑–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤**
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –ò–∑–º–µ–Ω–∏—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–æ–¥–µ–ª—å, —è–∑—ã–∫, –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –Ω–æ–≤—ã–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
   - –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ —Å–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–æ–≤—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π

6. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

7. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –±–æ—Ç–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û—Ü–µ–Ω–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏